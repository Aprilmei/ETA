<!DOCTYPE html>
<html lang="en">
<head>
  <title>ETA Predicting Travel Time for Dublin Bus Passengers</title>
  <!-- References: W3Schools Bootstrap Tutorial -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="style.css" rel="stylesheet" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <!--<script src="js/main.js" type="text/javascript"></script>-->
    <script src="{{ url_for('static', filename='js/main.js') }}" type="text/javascript"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOHmIoluu_RROTARx0AHofNWZbLHg8yxU&callback=initMap" async defer></script>
  <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/0.10.0/lodash.min.js" type="text/javascript"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>

</head>
    <body>
        <!-- Main div containing the whole page -->
        <div class="container">
            <!-- Jumbotron containg site title and tagline -->
            <div class="jumbotron">
                <h1 class="page-header">ETA<br><p>Delivering Accurate Travel Times to Dublin Bus Users</p></h1>
            </div>
            <div>
                <!-- Navigation Bar - Collapsible for Mobile Optimisation -->
                <nav class="navbar navbar-default">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a class="navbar-brand" href="#">ETA</a>
                        </div>
                        <div class="collapse navbar-collapse" id="myNavbar">
                            <ul class="nav navbar-nav">
                                <li class="active"><a href="#">Home</a></li>
                                <li><a href="#">Route Planner</a>
                                <li><a href="#">Timetables</a></li>
                                <li><a href="#">Contact</a></li>
                            </ul>
                            <ul class="nav navbar-nav navbar-right">
                                <li><a href="#"><span class="glyphicon glyphicon-log-in"></span>Login</a></li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>
            <!-- Very basic first prototype

            Only uses the number 7 from terminus to terminus on a Monday

            Estimate times taken from Dublin Bus Website for now - via a dummy csv
            
            -->
            <div class="container-fluid">
            <div class="row">
                <div class="col-md-8"><div id="map"></div></div>
                <div class="col-md-4"><h4>Route Preferences</h4>
                    <div id="preferences" class="form-group" action="../../static/js/main.js:travelTime">

                        <label for="origin">Origin:</label>
                        <select class="form-control" id="origin">
                            <option disabled="disabled" selected="selected">
				            Select your origin
			                </option>
                        </select>
                        
                        <label for="dest">Destination:</label>
                        <select class="form-control" id="dest">
                            <option disabled="disabled" selected="selected">
				            Select your destination
			                </option>
                        </select>

                       <label for="route">Route:</label>
                        <select class="form-control" id="route">
                           <option disabled="disabled" selected="selected">
				            Select a route
			                </option>
                        </select>

                        <label for="day">Day:</label>
                        <select class="form-control" id="day">
                            <option disabled="disabled" selected="selected">
				            Select a day
			                </option>
                            <option value="2">Monday</option>
                            <option value="3">Tuesday</option>
                            <option value="4">Wednesday</option>
                            <option value="5">Thursday</option>
                            <option value="6">Friday</option>
                            <option value="7">Saturday</option>
                            <option value="1">Sunday</option>
                        </select>

                        <label for="hour">Time:</label>
                        <!-- What about using the terminus departures? -->
                        <select class="form-control" id="hour">
                        </select><br>
                        <select class="form-control" id="minute">
                        </select><br>

                        <input type="button" class="btn btn-info" onclick="travelTime()" value="Submit">
                    </div>       
                </div>
            </div>
            <div id="results"></div>
            </div>
        </div>
    </body>
<footer>
    <p>This website was developed by<br>Andrew Cameron<br>Pamela Kelly<br>Conan Martin<br>April Mei<br>2017</p>
</footer>
<script>
    function pop_origin_stops() {
    var origin_drop = $('#origin');
	    $.getJSON("http://127.0.0.1:5000/stops", function(data) {
		    if ('stops' in data) {
			    var stops = data.stops;
			    console.log('stops', stops);
                _.forEach(stops, function(data) {
   				origin_drop.append($('<option>', {
					value: data.stop_id,
   					text: data.stop_address + " - Stop No: " + data.stop_id
  			    }, '</option>'));
                })
            }
        })
    };

    function pop_destination_stops(origin_id) {
    var destination_drop = $('#dest');
	    $.getJSON("http://127.0.0.1:5000/destination_stops/" + origin_id, function(data) {
		    if ('stops' in data) {
			    var stops = data.stops;
			    console.log('stops', stops);
                _.forEach(stops, function(data) {
   				destination_drop.append($('<option>', {
					value: data.stop_id,
   					text: data.stop_address + " - Stop No: " + data.stop_id
  			    }, '</option>'));
                })
            }
        })
    };

    function pop_routes(origin_id, destination_id) {
    var routes_drop = $('#route');
	    $.getJSON("http://127.0.0.1:5000/possible_routes/" + origin_id + "/" + destination_id, function(data) {
		    if ('routes' in data) {
			    var routes = data.routes;
			    console.log('routes', routes);
                _.forEach(routes, function(data) {
   				routes_drop.append($('<option>', {
					value: data.journey_pattern,
   					text: data.journey_pattern
  			    }, '</option>'));
                })
            }
        })
    };


    function time_picker(){
    var hour_list = document.getElementById('hour');
    var minute_list = document.getElementById('minute');

    for (var i = 0; i <= 24; i++){
        hour_list.options[hour_list.options.length] = new Option(i, i);
        }

    for (var i = 0; i <= 55; i += 5){
        minute_list.options[minute_list.options.length] = new Option(i, i);
        }

    }
    function remove_options(id, which){
        var list = document.getElementById(id);
        for (var i = list.length - 1; i >= 0 ; i--){
            list.remove(i);
        }
        var option = document.createElement("option");
        if (id === 'dest'){
            option.text = 'Select a destination';
        }
        else{
            option.text = "Select a " + id;
        }
        option.disabled = false;
        list.add(option);
        if (which === 'origin') {
            pop_destination_stops($("#origin").val());
        }
        else if (which === 'dest'){
            pop_routes($("#origin").val(), $("#dest").val());
        }
    }

    $("#origin").change(function() {
        remove_options('dest', 'origin');
        remove_options('route', 'ignore');
        });

    $("#dest").change(function() {
        remove_options('route', 'dest');
    });

    function get_weather() {
        var xmlhttp = new XMLHttpRequest();
        var url = "http://api.openweathermap.org/data/2.5/forecast?id=7778677&APPID=4cd167bc85dff937818ea9a5eb6fa550&units=metric";

        xmlhttp.onreadystatechange = function(){
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            var weather_json = JSON.parse(xmlhttp.responseText);
            apply_weather(weather_json);
        }
        };

        xmlhttp.open("GET", url, true);
        xmlhttp.send();

}

    function apply_weather(data){
        var list = data.list;
	    console.log('list', list);

    }


    window.onload = function(){
    pop_origin_stops();
    time_picker();
    get_weather();
    };


    $(document).ready(function() {
    $('#origin').select2();
    $('#dest').select2();

});

</script>
</html>